name: Auto PR from stage to main

on:
  push:
    branches: [stage]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure 'autopr' label exists
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          gh label create autopr \
            --description "Automated PR from stage to main" \
            --color "#006b75" 2>/dev/null || true

      - name: Fetch main branch
        run: git fetch origin main

      - name: Create or update PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          EXISTING_PR=$(gh pr list --base main --head stage --state open | awk 'NR==1 {print $1}' | tr -d '#' || true)

          if [ -z "$EXISTING_PR" ]; then
            # Get commit info
            COMMIT_COUNT=$(git log origin/main..HEAD --oneline | wc -l)
            LATEST_COMMIT=$(git log origin/main..HEAD --oneline -1)
            FILES_CHANGED=$(git diff --name-only origin/main...HEAD | wc -l)
            FILES_LIST=$(git diff --name-only origin/main...HEAD | sed 's/^/- /')
            COMMIT_LIST=$(git log origin/main..HEAD --pretty=format:'- %s' | head -10)

            # Generate title
            if [ "$COMMIT_COUNT" -eq 1 ]; then
              PR_TITLE=$(echo "$LATEST_COMMIT" | sed 's/^[0-9a-f]* //')
            else
              PR_TITLE="Merge stage: $COMMIT_COUNT commits, $FILES_CHANGED files"
            fi

            # Generate body
            PR_BODY="## ðŸ“Š Summary
            - **Commits**: $COMMIT_COUNT
            - **Files changed**: $FILES_CHANGED

            ## ðŸ“ Recent Commits
            $COMMIT_LIST

            ## ðŸ“ Changed Files
            $FILES_LIST

            ---
            _This PR was automatically created by GitHub Actions_"

            gh pr create \
              --base main \
              --head stage \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --label autopr
            PR_NUMBER=$(gh pr list --base main --head stage --state open | awk 'NR==1 {print $1}' | tr -d '#')
          else
            PR_NUMBER=$EXISTING_PR
          fi

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
