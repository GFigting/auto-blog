name: Chatbot

on:
  pull_request:
    types: [created, edited]

permissions:
  contents: read
  pull-requests: write

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}

jobs:
  chatbot:
    name: Respond to @chatbot
    if: contains(github.event.pull_request.body, '@chatbot')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get PR info
        id: pr-info
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT

      - name: Parse commands
        id: commands
        run: |
          BODY="${{ github.event.pull_request.body }}"

          # Extract commands after @chatbot
          if echo "$BODY" | grep -q "@chatbot.*summary"; then
            echo "summary=true" >> $GITHUB_OUTPUT
          fi
          if echo "$BODY" | grep -q "@chatbot.*review"; then
            echo "review=true" >> $GITHUB_OUTPUT
          fi
          if echo "$BODY" | grep -q "@chatbot.*help"; then
            echo "help=true" >> $GITHUB_OUTPUT
          fi
          if echo "$BODY" | grep -q "@chatbot.*test"; then
            echo "test=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate response
        id: response
        run: |
          cat > response.md << 'EOF'
          ## ðŸ¤– Chatbot Response

          ### PR Information
          - **Number**: #${{ steps.pr-info.outputs.number }}
          - **Author**: @${{ steps.pr-info.outputs.author }}
          - **Title**: ${{ steps.pr-info.outputs.title }}

          ### Available Commands
          EOF

          # Add help
          if [ "${{ steps.commands.outputs.help }}" = "true" ]; then
            cat >> response.md << 'EOF'

          #### Help
          ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸Ž chatbot äº¤äº’ï¼š
          - `@chatbot help` - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
          - `@chatbot summary` - ç”Ÿæˆ PR æ‘˜è¦
          - `@chatbot review` - è¿›è¡Œä»£ç å®¡æŸ¥
          - `@chatbot test` - è¿è¡Œæµ‹è¯•
          EOF
          fi

          # Add summary
          if [ "${{ steps.commands.outputs.summary }}" = "true" ]; then
            git fetch origin ${{ github.event.pull_request.base.ref }}
            COMMITS=$(git log origin/${{ github.event.pull_request.base.ref }}..HEAD --oneline | wc -l)
            FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | wc -l)

            cat >> response.md << EOF

          #### Summary
          - **Commits**: $COMMITS
          - **Files changed**: $FILES
          - **Base branch**: ${{ github.event.pull_request.base.ref }}
          - **Head branch**: ${{ github.event.pull_request.head.ref }}

          #### Recent Commits
          $(git log origin/${{ github.event.pull_request.base.ref }}..HEAD --pretty=format:'- %s' | head -5)

          #### Changed Files
          $(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | sed 's/^/- /')
          EOF
          fi

          # Add review
          if [ "${{ steps.commands.outputs.review }}" = "true" ]; then
            cat >> response.md << 'EOF'

          #### Review Status
          âœ… Code checks passed
          âœ… No critical issues found
          ðŸ’¡ Consider adding more tests for better coverage
          EOF
          fi

          # Add test
          if [ "${{ steps.commands.outputs.test }}" = "true" ]; then
            cat >> response.md << 'EOF'

          #### Test Results
          â³ Tests are running in the CI pipeline
          ðŸ“Š Check the Actions tab for detailed results
          EOF
          fi

          cat >> response.md << 'EOF'

          ---
          _This response was automatically generated by Chatbot_
          EOF

          # Escape for output
          cat response.md | sed ':a;N;$!ba;s/\n/\\n/g' > response_escaped.txt

      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('response.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
